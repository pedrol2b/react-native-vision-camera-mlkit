name: Build Example (iOS)

on:
  pull_request:
    branches: [main]
    paths:
      - 'ios/**'
      - 'example/ios/**'
      - '*.podspec'
      - 'package.json'
      - 'yarn.lock'
  push:
    branches: [main]
    paths:
      - 'ios/**'
      - 'example/ios/**'
      - '*.podspec'
      - 'package.json'
      - 'yarn.lock'
  merge_group:
    types: [checks_requested]

permissions:
  contents: read

concurrency:
  group: ios-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ios:
    runs-on: macos-latest

    env:
      XCODE_VERSION: 16.3
      RCT_USE_RN_DEP: 1
      RCT_USE_PREBUILT_RNCORE: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup environment
        uses: ./.github/actions/setup

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Resolve iOS simulator destination
        run: |
          SIMCTL_JSON="$(xcrun simctl list runtimes -j 2>/dev/null || true)"
          IOS_RUNTIME=$(SIMCTL_JSON="$SIMCTL_JSON" /usr/bin/python3 - <<'PY'
          import json
          import os
          import sys

          raw = os.environ.get("SIMCTL_JSON", "")
          if not raw.strip():
              sys.exit(0)

          try:
              data = json.loads(raw)
          except json.JSONDecodeError:
              sys.exit(0)

          runtimes = [
              runtime
              for runtime in data.get("runtimes", [])
              if runtime.get("platform") == "iOS" and runtime.get("isAvailable")
          ]
          if not runtimes:
              sys.exit(0)

          def version_key(runtime):
              return [int(part) for part in runtime.get("version", "0").split(".")]

          runtimes.sort(key=version_key)
          print(runtimes[-1]["version"], end="")
          PY
          )

          if [ -z "$IOS_RUNTIME" ]; then
            echo "No iOS simulator runtimes found." >&2
            exit 1
          fi

          echo "IOS_DESTINATION=platform=iOS Simulator,OS=${IOS_RUNTIME},name=iPhone 15" >> "$GITHUB_ENV"

      - name: Install CocoaPods
        run: |
          cd example
          bundle install
          bundle exec pod install --project-directory=ios

      - name: Build iOS example
        run: yarn turbo run build:ios
